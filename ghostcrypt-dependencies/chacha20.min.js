// Simple ChaCha20 implementation for GhostCrypt
// Based on RFC 7539
(function(){var chacha20={keystream:function(key,nonce,counter){if(key.length!==32)throw new Error("Key must be 32 bytes");if(nonce.length!==12)throw new Error("Nonce must be 12 bytes");var state=new Uint32Array(16);state[0]=0x61707865;state[1]=0x3320646e;state[2]=0x79622d32;state[3]=0x6b206574;for(var i=0;i<8;i++){state[4+i]=(key[i*4+0]<<0)|(key[i*4+1]<<8)|(key[i*4+2]<<16)|(key[i*4+3]<<24)}state[12]=counter;for(var i=0;i<3;i++){state[13+i]=(nonce[i*4+0]<<0)|(nonce[i*4+1]<<8)|(nonce[i*4+2]<<16)|(nonce[i*4+3]<<24)}var working=new Uint32Array(16);for(var i=0;i<16;i++)working[i]=state[i];function quarterRound(a,b,c,d){working[a]=(working[a]+working[b])|0;working[d]=((working[d]^working[a])<<16)|((working[d]^working[a])>>>16);working[c]=(working[c]+working[d])|0;working[b]=((working[b]^working[c])<<12)|((working[b]^working[c])>>>20);working[a]=(working[a]+working[b])|0;working[d]=((working[d]^working[a])<<8)|((working[d]^working[a])>>>24);working[c]=(working[c]+working[d])|0;working[b]=((working[b]^working[c])<<7)|((working[b]^working[c])>>>25)}for(var i=0;i<10;i++){quarterRound(0,4,8,12);quarterRound(1,5,9,13);quarterRound(2,6,10,14);quarterRound(3,7,11,15);quarterRound(0,5,10,15);quarterRound(1,6,11,12);quarterRound(2,7,8,13);quarterRound(3,4,9,14)}for(var i=0;i<16;i++){working[i]=(working[i]+state[i])|0}var keystream=new Uint8Array(64);for(var i=0;i<16;i++){keystream[i*4+0]=(working[i]>>>0)&0xff;keystream[i*4+1]=(working[i]>>>8)&0xff;keystream[i*4+2]=(working[i]>>>16)&0xff;keystream[i*4+3]=(working[i]>>>24)&0xff}return keystream},encrypt:function(key,nonce,data){var encrypted=new Uint8Array(data.length);var counter=0;var blockIndex=0;for(var i=0;i<data.length;i++){if(blockIndex===0||blockIndex===64){var block=chacha20.keystream(key,nonce,counter);counter++;blockIndex=0}encrypted[i]=data[i]^block[blockIndex];blockIndex++}return encrypted},decrypt:function(key,nonce,data){return chacha20.encrypt(key,nonce,data)}};if(typeof window!=='undefined'){window.ChaCha20=chacha20}if(typeof module!=='undefined'&&module.exports){module.exports=chacha20}})();
